<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Budget Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body class="bg-pink-50 min-h-screen p-6">

  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-gray-800">Budget Management</h1>
    <div class="flex items-center gap-4 mb-4">
        <div id="openPrefixModal" class="bg-indigo-500 text-white px-4 py-2 rounded-md cursor-pointer w-fit">
          Prefixes
        </div>
        <button id="addBudgetBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">+ Add Budget</button>
    </div>
  </div>

  <div class="flex items-center justify-between mb-4">
    <select id="monthPicker" class="p-2 border rounded-md text-sm"></select>
  </div>


  <div id="budget-container" class="space-y-4">
    <!-- Budget cards will be added here -->
  </div>
  
  <!-- Budget Adding Overlay + Modal (Initially hidden) -->
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center hidden z-50">
      <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-md space-y-4">
        <h2 id="budgetModalTitle" class="text-lg font-bold text-gray-700"></h2>

        <!-- Amount input -->
        <div class="relative">
          <input type="number" id="amountInput" min="0" class="w-full border border-gray-300 rounded-lg pl-4 pr-16 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Enter amount">
          <span class="absolute right-4 top-2.5 text-gray-500 font-semibold">VND</span>
        </div>

        <!-- Dropdown for category -->
        <select id="categorySelect" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400">
          <option value="">Select category...</option>
        </select>
        <div id="currentCategoryBudgetDiv" class="hidden">
            <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
            <label id="currentCategoryBudget" class="block text-sm font-bold text-black mb-1"></label>
        </div>
        
          <!-- Month/Year -->
          <div class="flex justify-between items-center w-full">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Selected Month</label>
              <label id="monthSelect" class="block text-sm font-bold text-black mb-1"></label>
            </div>

            <!-- Confirm button -->
            <div>
              <button id="confirmAddBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">Confirm</button>
            </div>
          </div>
      </div>
    </div>
        
    
       <!-- Prefix Modal -->
       <div id="prefixModal" class="fixed inset-0 bg-black bg-opacity-40 hidden flex justify-center items-center z-50">
         <div class="bg-white w-full max-w-md p-6 rounded-xl shadow-xl relative">
           <!-- Modal Header -->
           <div class="flex justify-between items-center mb-4">
             <h2 class="text-lg font-bold text-gray-800">Prefix Settings</h2>
             <button id="addPrefixBtn" class="text-sm text-indigo-600 hover:underline">+ Add</button>
           </div>

           <!-- Prefix List -->
           <div id="prefixList" class="space-y-3 max-h-60 overflow-y-auto">
             <!-- Dynamic list goes here -->
           </div>
           <br>

           <!-- Modal Footer -->
           <h2 class="text-xs text-red-500">Applying prefixes will override existed budget of the same category</h2>
           <div class="flex justify-between item-center mt-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Selected Month</label>
              <label id="monthSelectPrefix" class="block text-sm font-bold text-black mb-1"></label>
            </div>
             <button id="applyPrefixBtn" class="bg-indigo-500 text-white px-4 py-2 rounded-md hover:bg-indigo-600">
               Apply
             </button>
           </div>
         </div>
       </div>
       
    <!-- Prefix adding Overlay + Modal (Initially hidden) -->
    <div id="overlayAddingPrefix" class="fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center hidden z-50">
      <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-md space-y-4">
        <h2 id="prefixModalTitle" class="text-lg font-bold text-gray-700">Set New Prefix</h2>
        <h4 class="text-xs text-red-500">Created prefix cant be edit, removing is needed if you want to change amount</h4>

        <!-- Amount input -->
        <div class="relative">
          <input type="number" id="amountPrefixInput" min="0" class="w-full border border-gray-300 rounded-lg pl-4 pr-16 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Enter amount">
          <span class="absolute right-4 top-2.5 text-gray-500 font-semibold">VND</span>
        </div>

        <!-- Dropdown for category -->
        <select id="categoryPrefixSelect" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400">
          <option value="">Select category...</option>
        </select>

            <!-- Confirm button -->
            <div>
              <button id="confirmAddPrefixBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">Confirm</button>
            </div>
          </div>
      </div>
       
  <script>
    var userID = 3; // Temporaly hard-coded
    const MONTHS = [
      "January", "February", "March", "April", "May", "June",
      "July", "August", "September", "October", "November", "December"
    ];
    
    const mapCodeToIcon = {
        57946: "🍔",  // fastfood
        57815: "🚗",  // car
        58778: "🛍️",  // shopping
        58235: "💡",  // lightbulb
        58381: "🎬",  // movie
        57522: "💰",  // money
        58136: "🏠",  // home
        58822: "📱",  // smartphone
        58328: "🩺",  // medical
        58713: "🎓",  // school
        58007: "✈️",  // flight
        58856: "🎮"   // gaming
      };
      
      const mapIconToCode = {
        "🍔": 57946,
        "🚗": 57815,
        "🛍️": 58778,
        "💡": 58235,
        "🎬": 58381,
        "💰": 57522,
        "🏠": 58136,
        "📱": 58822,
        "🩺": 58328,
        "🎓": 58713,
        "✈️": 58007,
        "🎮": 58856
      };

    const monthPicker = document.getElementById("monthPicker");
    
    const prefixModal = document.getElementById("prefixModal");
    const openPrefixModal = document.getElementById("openPrefixModal");
    const prefixList = document.getElementById("prefixList");
    const prefixOverlay = document.getElementById("overlayAddingPrefix");
    
    let prefixData = [];
    
     openPrefixModal.addEventListener("click", () => {
        prefixModal.classList.remove("hidden");
        fetchPrefixes(userID);
      });

      document.getElementById("addPrefixBtn").addEventListener("click", () => {
          prefixOverlay.classList.remove("hidden");
          fetchAvailableCategoriesPrefix();
      });
      
      prefixOverlay.addEventListener('click', function (e) {
        if (e.target === prefixOverlay) {
          prefixOverlay.classList.add('hidden');
        }
      });

      document.getElementById("applyPrefixBtn").addEventListener("click", () => {
        if (confirm("Apply prefix?")){
            if(confirm("This will override budget if it already exist, apply prefix?")){
                const [year, month] = monthPicker.value.split("-").map(Number);
                fetchApplyPrefix(userID, month, year);
                prefixModal.classList.add("hidden");
                console.log("Applied prefixes");
                window.alert("Applied prefixes");
                setTimeout(() => {
                    loadBudgetsForMonth(userID, month, year);
                 }, 1200);
            }
        }
      });
      
      function fetchPrefixes(userID) {
        fetch(`/api/prefix/show?userID=${userID}`)
          .then(res => res.json())
          .then(data => {
            renderPrefixList(data);
          })
          .catch(err => console.error("Error fetching prefixes:", err));
      }
      
      function fetchApplyPrefix(userID, month, year){
        fetch(`/api/prefix/applyPrefix?userID=${userID}&month=${month}&year=${year}`,{
            method: "POST"
        })
          .then(res => res.text())
          .catch(err => console.error("Error applying prefixes:", err));
      }
      
    function fetchAvailableCategoriesPrefix() {
        fetch(`/api/categories/simpleCategoryForPrefix?userID=${userID}`)
          .then(res => res.json())
          .then(data => {
            const $select = $('#categoryPrefixSelect');
            $select.empty().append('<option value="">Select category...</option>');
            data.forEach(cat => {
                console.log(cat);
              $select.append(`<option value="${cat.categoryId}">${cat.name}</option>`);
            });
          });
    }


    function renderPrefixList(prefixes) {
      const $list = $('#prefixList');
      const [year, month] = monthPicker.value.split("-");
      $list.empty();

      prefixes.forEach(prefix => {
        const item = `
          <div class="flex justify-between items-center bg-gray-100 px-4 py-2 rounded">
            <span class="text-gray-700 font-medium">${prefix.categoryName}: ${prefix.amount} đ</span>
            <div class="flex gap-2">
              <button class="text-sm text-red-500 hover:underline delete-prefix" data-id="${prefix.prefixId}">Remove</button>
            </div>
          </div>
        `;
        $list.append(item);
      });
      $("#monthSelectPrefix").text(`${month}/${year}`);
    }
    

    function deletePrefix(id) {
      fetch(`/api/prefix/delete?id=${id}`, {
        method: 'DELETE'
      })
      .then(res => {
        if (!res.ok) throw new Error("Failed to delete prefix");
        return res.text(); // or .json()
      })
      .then(data => {
        console.log("Delete successful:", data);
        // Optionally re-fetch prefix list
        fetchPrefixes(userID);
      })
      .catch(err => console.error("Delete error:", err));
    }

    const now = new Date();

    // Populate dropdown
    for (let i = 0; i < 12; i++) {
      const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
      const month = date.getMonth();
      const year = date.getFullYear();
      const value = `${year}-${String(month + 1).padStart(2, "0")}`; // e.g., "2025-07"
      const label = `${MONTHS[month]} ${year}`;                       // e.g., "July 2025"
      const option = new Option(label, value);
      monthPicker.add(option);
    }

    // Access selected value
    monthPicker.addEventListener("change", () => {
      const value = monthPicker.value;         // e.g., "2025-07"
      const [year, month] = value.split("-");  // "2025", "07"
      
      loadBudgetsForMonth(userID, Number(month), Number(year));
      updateAddButtonState();
      updateApplyPrefixButtonState();
    });
    
    
    function createOverviewCard(allBudgets){
        var totalBudget = 0;
        var totalSpent = 0;
        allBudgets.forEach((budget) => {
           totalBudget = totalBudget + budget.amount;
           totalSpent = totalSpent + budget.spentAmount;
        });
        
        const remaining = totalBudget - totalSpent;
        const pickedDate = $("#monthPicker").val();
        const progress = totalBudget === 0 ? 0 : Math.min((totalSpent / totalBudget) * 100, 100).toFixed(1);
        const visualProgress = Math.min(progress, 100); // prevents overflow
        const progressColor = progress > 100 ? "bg-red-500" : "bg-green-500";
        
        
        return`
            <div class="bg-indigo-100 border-l-4 border-purple-400 rounded-xl shadow p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Budget Overview</h2>

            <div>
              <h3 class="text-sm">${pickedDate}</h3>
            </div>

            <div class="grid grid-cols-4 gap-4 mb-4 text-center">
              <div>
                <p class="text-gray-500 text-sm">Total Budget (VND)</p>
                <p id="totalBudget" class="text-lg font-semibold text-gray-700">${totalBudget} đ</p>
              </div>
              <div>
                <p class="text-gray-500 text-sm">Total Spent (VND)</p>
                <p id="totalSpent" class="text-lg font-semibold text-green-600">${totalSpent} đ</p>
              </div>
              <div>
                <p class="text-gray-500 text-sm">Remaining (VND)</p>
                <p id="totalRemaining" class="text-lg font-semibold ${remaining < 0 ? 'text-red-600' : 'text-green-600'}">${remaining} đ</p>
              </div>
              <div>
                <p class="text-gray-500">Progress</p>
                <p class="font-semibold">${progress}%</p>
              </div>
            </div>

            <div class="h-3 w-full bg-gray-200 rounded-full overflow-hidden">
              <div id="overviewProgress" class="h-3 ${progressColor} rounded-full transition-all duration-300" style="width: ${visualProgress}%"></div>
            </div>
          </div>
        <hr class="my-4 border-t-2 border-black" />
        `;
    }


    function createBudgetCard(budget) {
      const remaining = budget.amount - budget.spentAmount;
      const progress = ((budget.spentAmount / budget.amount) * 100).toFixed(1);
      const visualProgress = Math.min(progress, 100); // prevents overflow
      const progressColor = progress > 100 ? "bg-red-500" : "bg-green-500";
      const icon = mapCodeToIcon[budget.iconCode];
      const monthText = MONTHS[budget.month - 1] + " " + budget.year;

      return `
        <div class="bg-white shadow rounded-lg p-6">
          <div class="flex justify-between items-start">
            <div>
              <div class="flex items-center space-x-2 mb-1">
                <span class="font-semibold text-gray-800">${icon} ${budget.categoryName}</span>
              </div>
              <p class="text-sm text-gray-500">${monthText}</p>
            </div>
            <div class="flex space-x-2">
              <button class="edit-btn text-gray-400 hover:text-gray-600"
                data-id="${budget.budgetId}"
                data-amount="${budget.amount}"
                data-category="${budget.categoryId}"
                data-month="${budget.month}"
                data-year="${budget.year}"
                data-name="${budget.categoryName}"
              >✏️</button>
              <button class="delete-btn text-gray-400 hover:text-red-500" data-id="${budget.budgetId}">🗑️</button>
            </div>
          </div>
          <div class="grid grid-cols-4 gap-4 mt-4 text-sm">
            <div>
              <p class="text-gray-500">Budget</p>
              <p class="font-semibold">${budget.amount} đ</p>
            </div>
            <div>
              <p class="text-gray-500">Spent</p>
              <p class="font-semibold text-green-600">${budget.spentAmount} đ</p>
            </div>
            <div>
              <p class="text-gray-500">Remaining</p>
              <p class="font-semibold ${remaining < 0 ? 'text-red-600' : 'text-green-600'}">
                $${remaining} đ
              </p>
            </div>
            <div>
              <p class="text-gray-500">Progress</p>
              <p class="font-semibold">${progress}%</p>
            </div>
          </div>
          <div class="mt-4 h-2 w-full bg-gray-200 rounded-full">
            <div class="h-2 ${progressColor} rounded-full" style="width: ${visualProgress}%"></div>
          </div>
        </div>
      `;
    }
    
    const $container = $('#budget-container');
    
    function loadBudgetsForMonth(id, month, year) {
        $container.html('<p class="text-gray-400">Loading...</p>');

        fetch(`/api/budget/showByMonth?userID=${id}&month=${month}&year=${year}`)
          .then(res => {
            if (!res.ok) throw new Error("Failed to load budget data");
            return res.json();
          })
          .then(budgets => {
            $container.empty();
            if (!budgets.length) {
              $container.html('<p class="text-gray-500">No budgets available.</p>');
              return;
            }
            
            $container.append(createOverviewCard(budgets));

            budgets.forEach(budget => {
              const card = createBudgetCard(budget);
              $container.append(card);
            });
          })
          .catch(err => {
            $container.html(`<p class="text-red-500">Error: ${err.message}</p>`);
          });
      }
      
     function fetchAvailableCategories() {
        const [year, month] = monthPicker.value.split('-').map(Number);

        fetch(`/api/categories/simpleCategoryExpense?userID=${userID}&month=${month}&year=${year}`)
          .then(res => res.json())
          .then(data => {
            const $select = $('#categorySelect');
            $select.empty().append('<option value="">Select category...</option>');
            data.forEach(cat => {
                console.log(cat);
                console.log(month);
                console.log(year);
              $select.append(`<option value="${cat.categoryId}">${cat.name}</option>`);
            });
          });
      }
      
        function updateAddButtonState() {
          const addBtn = $("#addBudgetBtn");
            
          if (!monthPicker || !addBtn) return;

          const [selectedYear, selectedMonth] = monthPicker.value.split("-").map(Number);

          const now = new Date();
          const currentMonth = now.getMonth() + 1;
          const currentYear = now.getFullYear();

          const prevMonthDate = new Date(currentYear, currentMonth - 2);
          const prevMonth = prevMonthDate.getMonth() + 1;
          const prevYear = prevMonthDate.getFullYear();

          const isCurrent = selectedMonth === currentMonth && selectedYear === currentYear;
          const isPrevious = selectedMonth === prevMonth && selectedYear === prevYear;

          const shouldEnable = isCurrent || isPrevious;

          if (!shouldEnable) {
            addBtn.addClass('opacity-50 pointer-events-none');
          } else {
            addBtn.removeClass('opacity-50 pointer-events-none');
          }
        }
        
        function updateApplyPrefixButtonState() {
          const [selectedYear, selectedMonth] = monthPicker.value.split("-").map(Number);
          const openModal = $("#openPrefixModal");

          const now = new Date();
          const currentMonth = now.getMonth() + 1;
          const currentYear = now.getFullYear();

          const isThisMonth = selectedYear === currentYear && selectedMonth === currentMonth;
          const isPreviousMonth = 
            (selectedYear === currentYear && selectedMonth === currentMonth - 1) ||
            (selectedYear === currentYear - 1 && currentMonth === 1 && selectedMonth === 12);

          const shouldEnable = isThisMonth || isPreviousMonth;

          if (shouldEnable) {
            openModal.removeClass("opacity-50 pointer-events-none");
          } else {
            openModal.addClass("opacity-50 pointer-events-none");
          }
        }


    $(document).ready(function () {
      const [pickedYear, pickedMonth] = monthPicker.value.split("-");
        
        loadBudgetsForMonth(userID,Number(pickedMonth),Number(pickedYear));
        
        function handleAddBudget() {
          const amount = parseFloat($('#amountInput').val());
          const mode = $('#confirmAddBtn').data('mode');
          const id = $('#confirmAddBtn').data('id');

          if (!amount) {
            alert("Please enter a valid amount.");
            return;
          }

          if (mode === 'edit') {
            // Edit mode: only update amount
            const params = new URLSearchParams({ id, amount });

            fetch(`/api/budget/update?${params.toString()}`, {
              method: 'PUT'
            })
              .then(res => res.text())
              .then(response => {
                alert("Budget updated successfully!");
                $('#overlay').addClass('hidden');
                location.reload();
              })
              .catch(err => {
                alert("Error updating budget: " + err.message);
              });

            return;
          }

          // ADD mode
          const categoryID = $('#categorySelect').val();
          const userID = 3; // Hardcoded
          const [year, month] = monthPicker.value.split('-').map(Number);

          if (!categoryID || !month || !year) {
            alert("Please choose a categories!.");
            return;
          }

          const params = new URLSearchParams({
            userID,
            categoryID,
            amount,
            month,
            year
          });

          fetch(`/api/budget/insert?${params.toString()}`, {
            method: 'POST'
          })
            .then(res => res.text())
            .then(response => {
              alert("Budget added successfully!");
              $('#overlay').addClass('hidden');
              location.reload();
            })
            .catch(err => {
              alert("Error adding budget: " + err.message);
            });
        }

        
        $('#confirmAddBtn').on('click', handleAddBudget); // bind handler
        
        
        $('#addBudgetBtn').on('click', function () {
          const [year, month] = monthPicker.value.split('-').map(Number);
          
          $('#overlay').removeClass('hidden');
          $("#budgetModalTitle").text("Add New Budget");
          $("#monthSelect").text(`${month}/${year}`);

          // Delay fetching categories until after month options are rendered
          fetchAvailableCategories();
        });
        
        $('#overlay').on('click', function (e) {
            if (e.target === this) {
              $(this).addClass('hidden');
            } 
          });
          
        // Delegate click handler after rendering
        $('#budget-container').on('click', '.delete-btn', function () {
          const budgetId = $(this).data('id');

          if (!confirm("Are you sure you want to delete this budget?")) return;

          fetch(`/api/budget/delete?id=${budgetId}`, {
            method: 'DELETE'
          })
            .then(res => {
              if (!res.ok) throw new Error("Delete failed");
              return res.text();
            })
            .then(msg => {
              alert("Deleted successfully!");
              location.reload();
            })
            .catch(err => {
              alert("Error deleting: " + err.message);
            });
        });
        
        $('#budget-container').on('click', '.edit-btn', function () {
          const $btn = $(this);
          const id = $btn.data('id');
          const amount = $btn.data('amount');
          const categoryId = $btn.data('category');
          const categoryName = $btn.data('name');
          const [year, month] = monthPicker.value.split('-').map(Number);


          // Open modal
          $('#overlay').removeClass('hidden');
          $("#budgetModalTitle").text(`Editing ${categoryName}'s budget`);
          $('#amountInput').val(amount);
          $('#confirmAddBtn').data('mode', 'edit').data('id', id).text('Confirm');

          // Disable category & month dropdowns
          $('#categorySelect').hide();
          $("#currentCategoryBudgetDiv").removeClass("hidden");
          $("#currentCategoryBudget").text(categoryName);
          $('#monthSelect').text(`${month}/${year}`);

          // Load categories and select current one
          fetch('/api/categories')
            .then(res => res.json())
            .then(data => {
              const $select = $('#categorySelect');
              $select.empty().append('<option value="">Select category...</option>');
              data.forEach(cat => {
                const selected = cat.categoryId === categoryId ? 'selected' : '';
                $select.append(`<option value="${cat.categoryId}" ${selected}>${cat.categoryName}</option>`);
              });
            });
        });

          
        function handleEditButtonClick(budget) {
            $('#overlay').removeClass('hidden');
            $('#amountInput').val(budget.amount);
            $('#confirmAddBtn').data('mode', 'edit').data('budgetId', budget.budgetId);

            // Hide or disable dropdowns
            $('#categorySelect').val(budget.categoryId).prop('disabled', true);
            $('#monthSelect').val(`${budget.month}-${budget.year}`).prop('disabled', true);
        }
          
        function resetModal() {
            $('#amountInput').val('');
            $('#categorySelect').prop('disabled', false).val('');
            $('#monthSelect').prop('disabled', false).val('');
            $('#confirmAddBtn').removeData('mode').removeData('budgetId');
            $("#categorySelect").show();
            $("#currentCategoryBudgetDiv").addClass("hidden");
        }

        $('#overlay').on('click', function (e) {
            if (e.target === this) {
              $(this).addClass('hidden');
              resetModal();
              $('#amountPrefixInput').val("");
              $('#categoryPrefixSelect').val("");
            }
        });
        
        $('#prefixModal').on('click', function (e) {
            if ($(e.target).is('#prefixModal')) {
              $('#prefixModal').addClass('hidden');
              $('#amountPrefixInput').val("");
              $('#categoryPrefixSelect').val("");
            }
        });
        
        
        $('#prefixList').on('click', '.delete-prefix', function () {
            const prefixId = $(this).data('id');
            if (confirm('Are you sure you want to delete this prefix?')) {
                deletePrefix(prefixId);
                setTimeout(() => {
                    alert("Prefix deleted successfully!");
                }, 100);
            }
        });

        
        $('#confirmAddPrefixBtn').on('click', function (e) {
            e.preventDefault();
            
            const amount = parseFloat($('#amountPrefixInput').val());
            const categoryId = $('#categoryPrefixSelect').val();

            if (!categoryId) {
              alert("Please select a category.");
              return;
            }

            if (isNaN(amount) || amount <= 0) {
              alert("Please enter a valid amount.");
              return;
            }

            fetch(`/api/prefix/insert?cateID=${categoryId}&userID=${userID}&amount=${amount}`, {
              method: 'POST'
            })
            .then(res => {
              if (!res.ok) throw new Error('Failed to insert prefix');
              return res.text(); // or res.json() if your API returns JSON
            })
            .then(response => {
              alert('Prefix added successfully!');
              $('#overlayAddingPrefix').addClass('hidden');
              $('#amountPrefixInput').val("");
              $('#categoryPrefixSelect').val("");
              fetchPrefixes(userID); // Re-fetch and re-render prefix list
            })
            .catch(err => {
              console.error('Insert error:', err);
              alert('Failed to add prefix.');
            });
          });

    });
  </script>
</body>
</html>
